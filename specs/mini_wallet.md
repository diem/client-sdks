# Diem MiniWallet

MiniWallet is a highly simplified wallet application backend service API.

The API is a minimum interface for wallet applications to do peer to peer payment.


## Goals

1. Demonstrate SDK features for integrating an application with Diem Payment Network.
2. Play as counterparty wallet application for wallet applications CI builds.
3. Develop a standard test suite for improving the ramp-up time of building Diem wallet applications.
4. Develop a standard test suite for testing cross-language SDKs features.


## Use Cases

![Use Cases](mini_wallet/use-cases.png)


## API Specification

The MiniWallet API is organized around [REST], accepts JSON-encoded request bodies, returns JSON-encoded responses, and uses standard HTTP response codes and verbs.

We value simplicity in favor of performance in MiniWallet API design. Providing a minimum HTTP interface is key to achieve goals.


### Endpoints Overview

1. Server responses 200 for succeeded request.
2. For `POST` creation request, server should accept JSON encoded request body, and response created resource JSON as the body of the response; no `Location` header is required.
3. Server should set `Content-Type` header to `application/json` for JSON responses.
4. Server should respond 400 for client error,  and 500 for server internal error.
5. There is no requirement about the response body for errors; recommend human readable messages and stack traces for easy debugging.


Minimum Endpoints

| Method | Path                                 | Request Body | Response Code | Response Body | Description                                                                 |
|--------|--------------------------------------|--------------|---------------|---------------|-----------------------------------------------------------------------------|
| POST   | `/accounts`                          | Account      | 201 Created   | Account       | Create a new account with KYC data and initial deposit balances.            |
| GET    | `/accounts/:account_id/balances`     | N/A          | 200 OK        | Balances      | Returns account balances. Should check Diem incoming txns and include them. |
| POST   | `/accounts/:account_id/payment_uris` | PaymentURI   | 201 Created   | PaymentURI    | Create and return a [Payment URI] for receiving payment.                    |
| POST   | `/accounts/:account_id/payments`     | Payment      | 202 Accepted  | Payment       | Send a payment to a payee.                                                  |


Offchain PaymentCommand Test Required Endpoint

| Method | Path          | Request Body | Response Code | Response Body | Description                                         |
|--------|---------------|--------------|---------------|---------------|-----------------------------------------------------|
| GET    | `/kyc_sample` | N/A          | 200 OK        | KycSample     | Returns [KycSample] for clients to use in the test. |


Optional Debugging APIs:

| Method | Path                           | Request Body | Response Code | Response Body | Description                                                                          |
|--------|--------------------------------|--------------|---------------|---------------|--------------------------------------------------------------------------------------|
| GET    | `/accounts/:account_id/events` | N/A          | 200 OK        | List<Event>   | Returns all events happened in the system for the account, ordered by creation time. |


Offchain API Endpoint: see [Diem Off-chain API] endpoint requirement.

### Resources

`Type` column flags:
1. `?`: nullable field
2. `!`: read-only field. It may be sent as part of a response but SHOULD NOT be sent as part of the request.
3. `*`: write-only field. It may be sent as part of a request but SHOULD NOT be sent as part of the response.

Reference resource id by the format: `<snake_case_resource_name>_id`, for example: `account_id` means `Account` resource `id` attribute value.


#### Account

Account holds KYC data, and all other resources are scoped by account id.

| Attribute  | Type                | Description                                                              |
|------------|---------------------|--------------------------------------------------------------------------|
| `id`       | string!             | Id generated by server for this account resource.                        |
| `kyc_data` | string              | Valid [KycDataObject] JSON-encoded string.                               |
| `balances` | map[string, uint]?* | Balance amount per currency code. Currency code is key, amount is value. |

> Server should send the account id as `additional_kyc_data`, if it is requested by the counterparty service


#### Balances

Account balances is a map of currency code to amount.
We can also consider it is an object has attributes named by currency code like the followings:

| Attribute | Type  | Description               |
|-----------|-------|---------------------------|
| `XUS`     | uint! | Amount of `XUS` currency. |
| `XDX`     | uint! | Amount of `XDX` currency. |



#### Payment URI

Payment URI is used for receiving payment from payers.


| Attribute     | Type    | Description                                    |
|---------------|---------|------------------------------------------------|
| `id`          | string! | Id of this resource, maybe used in event data. |
| `account_id`  | string! | Id of associated account resource              |
| `currency`    | string? | Currency code of the payment.                  |
| `amount`      | string? | Amount of the payment.                         |
| `payment_uri` | string! | [Payment URI] for receiving the payment.       |


#### Payment

Payment resource is a record of sending funds from the account to the payee's account.

| Attribute    | Type    | Description                                                          |
|--------------|---------|----------------------------------------------------------------------|
| `id`         | string! | Id of this resource, maybe used in event data.                       |
| `account_id` | string! | Id of associated account resource                                    |
| `currency`   | string  | Diem currency code.                                                  |
| `amount`     | uint    | Amount of the transaction.                                           |
| `payee`      | string  | [Diem Account Identifier], the receiver of the payment. |


#### Kyc Sample

KYC data sample for clients to create accounts to do off-chain KYC data exchanging tests.
The `minimum` sample will be used for generating KYC data in happy path test cases.
`Reject`, `soft_match`, `soft_reject` are used for the test cases that need trigger rejection or soft match PaymentCommand.

| Attribute     | Type    | Description                   |
|---------------|---------|-------------------------------|
| `minimum`     | string! | JSON-encoded [KycDataObject]. |
| `reject`      | string! | JSON-encoded [KycDataObject]. |
| `soft_match`  | string! | JSON-encoded [KycDataObject]. |
| `soft_reject` | string! | JSON-encoded [KycDataObject]. |


#### Event

Event is optional to implement, it is a log of what happened in the system.


| Attribute    | Type    | Description                                                                        |
|--------------|---------|------------------------------------------------------------------------------------|
| `id`         | string! | Unique identifier of the event                                                     |
| `account_id` | string! | Id of associated account resource                                                  |
| `type`       | string! | Event type                                                                         |
| `data`       | string! | Event data should be interpreted based on the `type`. See the event types details. |
| `timestamp`  | uint!   | Milliseconds since the unix epoch. The time event object is created by the system. |


Event types Python SDK MiniWallet implementation plan to provide:

| Event Type                | Data Attr Type | Description                                                                                  |
|---------------------------|----------------|----------------------------------------------------------------------------------------------|
| `info`                    | string         | Human readable message for whatever happened.                                                |
| `error`                   | string         | Human readable error messages.                                                               |
| `created_account`         | JSON           | Account resource attributes.                                                                 |
| `created_transaction`     | JSON           | Incoming or outgoing transaction information.                                                |
| `updated_transaction`     | JSON           | Outgoing transaction updated data when Diem transaction is created, submitted and executed . |
| `created_payment_uri`     | JSON           | PaymentURI resource attributes.                                                              |
| `created_payment_command` | JSON           | Off-chain payment command data with cid and reference_id.                                    |
| `updated_payment_command` | JSON           | Off-chain payment command data with cid and reference_id                                     |


[KycSample]: #kyc-sample
[REST]: https://en.wikipedia.org/wiki/Representational_state_transfer
[Diem Account Identifier]: https://dip.diem.com/dip-5/#account-identifiers
[KycDataObject]: https://dip.diem.com/dip-1/#kycdataobject
[PaymentCommand]: https://dip.diem.com/dip-1/#paymentcommand-object
[PaymentActorObject]: https://dip.diem.com/dip-1/#paymentactorobject
[CommandRequestObject]: https://dip.diem.com/dip-1/#commandrequestobject
[Diem Off-chain API]: https://dip.diem.com/dip-1
[Payment URI]: https://dip.diem.com/dip-5/#intent-identifiers
